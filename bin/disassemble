#!/usr/bin/env ruby

# RUBY_GC_HEAP_INIT_SLOTS=45000
# ./bin/disassemble vice-city games/vice-city/data/main.scm _out/vice-city Sexp

# NEXT:
# ID integers from .ide files

if ENV["PWD"].split(/\//)[-1] == "gta-scm"
  $: << "./lib"
  require 'gta_scm'
end

logger.info ARGV.inspect

mem_use_bytes = (`ps -o rss= -p #{$$}`.to_i * 1024)
logger.info "Memory usage: #{mem_use_bytes/1024/1024} MB"

scm = GtaScm::Scm.load(ARGV[0],ARGV[1])

scm.load_opcode_definitions!

parser = GtaScm::Parser.new(scm,0)
# parser = GtaScm::MultithreadParser.new(scm,0)

parser.load_opcode_definitions( scm.opcodes )

begin
  parser.parse!
  logger.info "Parser complete"
rescue => ex
  logger.error "We fucked up: #{ex.message}"
  ex.backtrace.each {|line| logger.debug line }
  logger.error "Dumping currently-parsed SCM"
end

scm.load_from_parser(parser)

format = ARGV[3].present? ? ARGV[3] : nil
if format
  logger.info "Outputting as #{format}"
  dis = GtaScm::Disassembler.const_get(format).new(scm)
  dis.disassemble(ARGV[2])
else
  logger.info "Skipping output (specify format as ARGV[3])"
end


mem_use_bytes = (`ps -o rss= -p #{$$}`.to_i * 1024)
logger.info "Memory usage: #{mem_use_bytes/1024/1024} MB"
# logger.info "GC stats: #{GC.stat.inspect}"
